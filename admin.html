<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, push, set, child, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAQewV9G-RCX1sXTHv1RY2b6z-oSOeYT9E",
    authDomain: "fanchallenge-38077.firebaseapp.com",
    databaseURL: "https://fanchallenge-38077-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "fanchallenge-38077",
    storageBucket: "fanchallenge-38077.appspot.com",
    messagingSenderId: "1033231507230",
    appId: "1:1033231507230:web:8a7b8b57891a6b07efb30f",
    measurementId: "G-ZMM7YPH7DL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dmdcqdfci/image/upload';
  const UPLOAD_PRESET = 'fansss'; // ✅ 여기만 변경!
  const UPLOAD_FOLDER = 'teams';

  window.onload = () => {
    const code = prompt("관리자 코드를 입력하세요");
    if (code !== 'aaa') {
      alert("코드가 올바르지 않습니다.");
      window.location.href = "index.html";
      return;
    }
    loadTeams();
  };

  window.addTeam = () => {
    const name = document.getElementById('teamName').value.trim();
    const file = document.getElementById('teamImage').files[0];

    if (!name || !file) return alert('팀 이름과 이미지를 입력하세요');

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);
    formData.append('folder', UPLOAD_FOLDER);

    axios.post(CLOUDINARY_URL, formData)
      .then(response => {
        const imageUrl = response.data.secure_url;
        const teamRef = push(ref(db, 'teams'));
        return set(teamRef, {
          name: name,
          image: imageUrl,
          steps: 0
        });
      })
      .then(() => {
        alert("팀이 추가되었습니다.");
        document.getElementById('teamName').value = '';
        document.getElementById('teamImage').value = '';
        loadTeams();
      })
      .catch(error => {
        console.error("오류 발생:", error);
        alert("팀 추가 실패: " + error.message);
      });
  };

  window.loadTeams = () => {
    const teamList = document.getElementById('teamList');
    teamList.innerHTML = '';
    get(child(ref(db), 'teams')).then(snapshot => {
      if (snapshot.exists()) {
        const teams = snapshot.val();
        Object.entries(teams).forEach(([_, data]) => {
          const div = document.createElement('div');
          div.className = 'team-card';
          div.innerHTML = `
            <img src="${data.image}" alt="${data.name}">
            <p>${data.name}</p>
          `;
          teamList.appendChild(div);
        });
      }
    });
  };
</script>
